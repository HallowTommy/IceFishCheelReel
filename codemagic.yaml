workflows:
  ios-godot:
    name: iOS Godot 4.6.1 Build (App Store)
    instance_type: mac_mini_m2
    max_build_duration: 60

    environment:
      groups:
        - ICEFISH
      vars:
        GODOT_TEMPL_VERSION_DIR: "4.6.1.stable"
        EXPORT_PRESET: "iOS"
        APPSTORE_KEY_ID: "HJVGKL3JHV"
        APPSTORE_ISSUER_ID: "8dc9f774-55a2-40f2-ae00-9167b7c5bf1f"
      ios_signing:
        provisioning_profiles:
          - ICEFISH_APPSTORE_PROFILE

    scripts:
      - name: Install dependencies
        script: |
          brew update
          brew install curl unzip || true

      - name: Download Godot 4.6.1
        script: |
          set -e
          mkdir -p tools
          cd tools
          curl -L --fail -o godot.zip \
            https://github.com/godotengine/godot/releases/download/4.6.1-stable/Godot_v4.6.1-stable_macos.universal.zip
          unzip -o godot.zip
          chmod +x Godot*.app/Contents/MacOS/Godot* || true

      - name: Download export templates
        script: |
          set -e
          mkdir -p tools
          cd tools
          curl -L --fail -o templates.tpz \
            https://github.com/godotengine/godot/releases/download/4.6.1-stable/Godot_v4.6.1-stable_export_templates.tpz

          TEMPL_DIR="$HOME/Library/Application Support/Godot/export_templates/${GODOT_TEMPL_VERSION_DIR}"
          mkdir -p "$TEMPL_DIR"

          rm -rf templates || true
          unzip -o templates.tpz
          if [ -d "templates" ]; then
            mv -f templates/* "$TEMPL_DIR/"
          else
            mv -f ./*.zip "$TEMPL_DIR/" || true
          fi

          echo "Templates installed:"
          ls -la "$TEMPL_DIR" || true

      - name: Export iOS project
        script: |
          set -e
          mkdir -p "./build/ios"
          GODOT_BIN=$(find tools -type f -path "*Godot*.app/Contents/MacOS/*" | head -n 1)
          echo "Using Godot: $GODOT_BIN"
          "$GODOT_BIN" --headless --path . --export-release "${EXPORT_PRESET}" "./build/ios"

          echo "Xcode projects found:"
          find ./build -maxdepth 8 -name "*.xcodeproj" -print || true

      - name: Build IPA (Codemagic signing)
        script: |
          set -e

          XCODEPROJ=$(find ./build -maxdepth 10 -name "*.xcodeproj" | head -n 1)
          echo "Project: $XCODEPROJ"
          [ -n "$XCODEPROJ" ]

          SCHEME=$(xcodebuild -list -project "$XCODEPROJ" \
            | awk '/Schemes:/{flag=1;next} flag && NF{print; exit}' \
            | xargs)
          echo "Scheme: $SCHEME"
          [ -n "$SCHEME" ]

          # применяем профили из ios_signing (убирает конфликт signing)
          xcode-project use-profiles --project "$XCODEPROJ"

          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$CM_BUILD_DIR/App.xcarchive" \
            archive
          
          cat > "$CM_BUILD_DIR/ExportOptions.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.cerentaner.icefishadventure</key>
              <string>IceFishProfile</string>
            </dict>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$CM_BUILD_DIR/App.xcarchive" \
            -exportPath "ipa" \
            -exportOptionsPlist "$CM_BUILD_DIR/ExportOptions.plist"

      - name: Upload to App Store Connect
        script: |
          set -e

          cd ipa
          ls -la
          test -f ios.ipa

          echo "KEY_ID: $APPSTORE_KEY_ID"
          echo "ISSUER_ID prefix: ${APPSTORE_ISSUER_ID:0:8}..."
          echo "ASC_PRIVATE_KEY length: ${#ASC_PRIVATE_KEY}"

          # если ключ пустой — сразу понятная ошибка
          if [ -z "$ASC_PRIVATE_KEY" ]; then
            echo "ERROR: ASC_PRIVATE_KEY is empty. Add it as a Secret env var (or in ICEFISH group)."
            exit 1
          fi

          printf "%s" "$ASC_PRIVATE_KEY" > /tmp/AuthKey.p8

          python3 - <<'PY'
          import pathlib
          p = pathlib.Path("/tmp/AuthKey.p8")
          s = p.read_text()
          s = s.replace("\\n", "\n").replace("\r\n", "\n").strip() + "\n"
          p.write_text(s)
          PY

          head -n 1 /tmp/AuthKey.p8

          app-store-connect publish \
            --path ios.ipa \
            --key-id "$APPSTORE_KEY_ID" \
            --issuer-id "$APPSTORE_ISSUER_ID" \
            --private-key /tmp/AuthKey.p8 \
            --testflight


    artifacts:
      - ipa/*.ipa
      - build/**/*
